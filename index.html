<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LuhvVerse - Your Digital Constellation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Phosphor Icons for a clean, modern look -->
    <script src="https://unpkg.com/phosphor-icons"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase components globally
        window.FirebaseServices = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, where, getDocs, onSnapshot, deleteDoc, writeBatch, setLogLevel
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600&display=swap');
        :root {
            /* Color Scheme */
            --neon-purple: #9B59B6;
            --electric-blue: #3498DB;
            --soft-black: #1E1E1E;
            --white: #FFFFFF;

            /* Fonts */
            --font-display: 'Orbitron', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--soft-black);
            color: var(--white);
            overflow-x: hidden;
            background-image: radial-gradient(circle at top right, rgba(155, 89, 182, 0.1) 0%, rgba(30, 30, 30, 0) 60%);
            animation: digitalWave 30s linear infinite alternate;
        }

        @keyframes digitalWave {
            from { background-position: 0% 0%; }
            to { background-position: 100% 100%; }
        }

        .neon-text-purple {
            color: var(--neon-purple);
            text-shadow: 0 0 5px var(--neon-purple), 0 0 10px var(--neon-purple);
            font-family: var(--font-display);
        }

        .neon-text-blue {
            color: var(--electric-blue);
            text-shadow: 0 0 5px var(--electric-blue), 0 0 10px var(--electric-blue);
        }

        .neon-button {
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
            border: 2px solid var(--electric-blue);
        }

        .neon-button:hover {
            background-color: var(--electric-blue);
            color: var(--soft-black);
            box-shadow: 0 0 20px var(--electric-blue);
        }

        .neon-input {
            background-color: rgba(30, 30, 30, 0.7);
            border: 1px solid var(--neon-purple);
            box-shadow: 0 0 5px rgba(155, 89, 182, 0.5);
        }

        .neon-input:focus {
            outline: none;
            border-color: var(--electric-blue);
            box-shadow: 0 0 8px var(--electric-blue);
        }

        .chat-bubble {
            border-radius: 1rem 1rem 1rem 0;
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(52, 152, 219, 0.1));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(155, 89, 182, 0.4);
            animation: floatUp 0.5s ease-out;
        }

        .chat-bubble-self {
            border-radius: 1rem 1rem 0 1rem;
        }

        @keyframes floatUp {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading Animation */
        .universe-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--soft-black);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .loader-glow {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--electric-blue) 0%, rgba(52, 152, 219, 0) 70%);
            animation: pulseGlow 1.5s infinite alternate;
        }

        @keyframes pulseGlow {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 1; }
        }

        /* Custom Scrollbar for Chat */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        #chat-messages::-webkit-scrollbar-track {
            background: rgba(30, 30, 30, 0.5);
        }

        #chat-messages::-webkit-scrollbar-thumb {
            background-color: var(--neon-purple);
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .staff-bg {
            background-color: rgba(155, 89, 182, 0.15);
        }

        /* Favicon/Logo SVG */
        .luhvverse-logo {
            width: 32px;
            height: 32px;
            display: inline-block;
        }
        .luhvverse-logo svg {
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- The Universe Loading Sequence (Hidden by default) -->
    <div id="universe-loader" class="universe-loader hidden">
        <div class="loader-glow"></div>
        <h2 class="text-2xl mt-8 neon-text-blue">Syncing with the Constellation...</h2>
        <p class="text-white mt-2">Entering LuhvVerse...</p>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="p-4 md:p-8">
        <!-- Navigation Header -->
        <header class="flex justify-between items-center py-4 px-6 rounded-xl backdrop-blur-lg bg-soft-black/80 shadow-2xl shadow-neon-purple/20 mb-6">
            <div class="flex items-center space-x-3">
                <div class="luhvverse-logo">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                        <!-- Neon Purple (L) -->
                        <path d="M 20 20 L 20 80 L 70 80" stroke="#9B59B6" stroke-width="8" style="filter:drop-shadow(0 0 4px #9B59B6);" />
                        <!-- Electric Blue (V) -->
                        <path d="M 80 20 L 50 80 L 20 20" stroke="#3498DB" stroke-width="8" style="filter:drop-shadow(0 0 4px #3498DB);" />
                        <!-- Core Dot/Star -->
                        <circle cx="50" cy="50" r="5" fill="#FFFFFF" style="filter:drop-shadow(0 0 3px #FFFFFF);" />
                    </svg>
                </div>
                <h1 class="text-3xl font-bold neon-text-purple">LuhvVerse</h1>
            </div>
            <nav id="nav-links" class="space-x-4 flex items-center"></nav>
        </header>

        <!-- Main Content Area -->
        <main id="content" class="min-h-[70vh]"></main>

        <!-- Global Status/Error Message Modal -->
        <div id="status-modal" class="fixed inset-0 bg-soft-black/70 backdrop-blur-sm z-50 hidden flex justify-center items-center">
            <div class="bg-soft-black/90 p-8 rounded-2xl w-full max-w-sm border border-neon-purple shadow-xl shadow-neon-purple/30 text-center animate-bounce-in">
                <p id="status-message" class="text-lg font-semibold neon-text-blue"></p>
                <button onclick="document.getElementById('status-modal').classList.add('hidden')" class="mt-4 px-4 py-2 rounded-lg neon-button text-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONSTANTS, UTILITIES, AND CONFIGURATION ---

        // Firebase Configuration (MUST be globally available for module imports)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { /* Fallback for local testing */ };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-luhvverse-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Role Hierarchy and Permissions (UPDATED)
        const ROLES = {
            'LuhvReuben': 7, // Supreme role for the first user
            'Starlight Commander': 6, // Top Executive
            'Cosmic Captain': 5,      // High-level Executive
            'Nebula Officer': 4,      // Mid-high Executive
            'Meteor Knight': 3,       // Moderator / Rule Enforcer
            'Orbit Squire': 2,        // Entry-level staff
            'Lunar Guard': 1,         // Chat monitor
            'Solar Herald': 1,        // Announcer (grouped with Lunar Guard for simplicity in rank check)
            'Galactic Explorer': 0    // Regular members
        };

        const staffRoles = ['LuhvReuben', 'Starlight Commander', 'Cosmic Captain', 'Nebula Officer', 'Meteor Knight', 'Orbit Squire', 'Lunar Guard', 'Solar Herald'];

        // Firestore Paths (Securely scoped per application and user)
        const PATHS = {
            USERS: `artifacts/${appId}/public/data/luhvverse_users`, // Public user profiles/roles
            CHAT: `artifacts/${appId}/public/data/luhvverse_chat`, // Real-time chat messages
            LOGS: `artifacts/${appId}/public/data/luhvverse_staff_logs`, // Staff actions
            SETTINGS: (userId) => `artifacts/${appId}/users/${userId}/luhvverse_settings/data` // Private user settings
        };

        // UI State
        let db, auth;
        let userId = null;
        let userProfile = null;
        let currentPage = window.location.hash.substring(1) || 'home';
        let chatUnsubscribe = null; // Store the chat listener unsubscribe function

        // Utility: Show Status Message
        function showStatus(message, isError = false) {
            const statusModal = document.getElementById('status-modal');
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            statusMessage.classList.toggle('neon-text-blue', !isError);
            statusMessage.classList.toggle('text-red-400', isError);
            statusModal.classList.remove('hidden');

            // Hide after 5 seconds if not an error
            if (!isError) {
                setTimeout(() => statusModal.classList.add('hidden'), 5000);
            }
        }

        // Utility: Hash Password Simulation (for storing profiles in Firestore)
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0; // Convert to 32bit integer
            }
            return hash.toString(16);
        }

        // Utility: Role Check
        function hasRole(minRole) {
            if (!userProfile) return false;
            return ROLES[userProfile.role] >= ROLES[minRole];
        }

        /**
         * Shows the 3-second animated universe loading screen.
         * @param {string} message - The message to display during loading.
         */
        async function showUniverseLoading(message) { // CORRECTED NAME
            const loader = document.getElementById('universe-loader');
            // Split message by period to set title and subtitle
            loader.querySelector('h2').textContent = message.split('.')[0].trim() + '...';
            loader.querySelector('p').textContent = message.split('.').length > 1 ? message.split('.')[1].trim() : 'Please wait.';
            loader.classList.remove('hidden');
            await new Promise(resolve => setTimeout(resolve, 3000));
            loader.classList.add('hidden');
        }

        // --- AUTHENTICATION AND INITIALIZATION ---

        async function initFirebase() {
            if (typeof FirebaseServices === 'undefined') {
                console.error("Firebase services not loaded. Check script imports.");
                return;
            }

            try {
                // Set debug logging for Firestore operations
                FirebaseServices.setLogLevel('Debug');

                const app = FirebaseServices.initializeApp(firebaseConfig);
                db = FirebaseServices.getFirestore(app);
                auth = FirebaseServices.getAuth(app);

                // Initial Authentication Check
                if (initialAuthToken) {
                    await FirebaseServices.signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await FirebaseServices.signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

                // Listen for Auth State Changes
                FirebaseServices.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadUserProfile(userId);
                        renderNavigation();
                        // If successfully authenticated and has a profile, check if a page requires login
                        if (['chat', 'settings', 'admin'].includes(currentPage) && !userProfile) {
                            showStatus("Please complete your LuhvVerse profile (Signup) or log in to continue.", true);
                            navigate('login');
                        } else if (!userProfile && currentPage !== 'login' && currentPage !== 'signup') {
                            // If signed in but no profile, redirect to login/signup flow
                            navigate('login');
                        } else {
                            navigate(currentPage);
                        }
                    } else {
                        userId = null;
                        userProfile = null;
                        renderNavigation();
                        if (['chat', 'settings', 'admin'].includes(currentPage)) {
                            navigate('home');
                        } else {
                            navigate(currentPage);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showStatus(`Universe connection failed: ${error.message}`, true);
            }
        }

        async function loadUserProfile(uid) {
            if (chatUnsubscribe) { chatUnsubscribe(); chatUnsubscribe = null; } // Cleanup old chat listener
            const docRef = FirebaseServices.doc(db, PATHS.USERS, uid);
            const docSnap = await FirebaseServices.getDoc(docRef);

            if (docSnap.exists()) {
                userProfile = docSnap.data();
                
                // --- NEW: Check for expired mutes/bans ---
                const now = new Date();
                let updates = {};

                // Check if mute is expired
                if (userProfile.isMuted && userProfile.muteExpiresAt && new Date(userProfile.muteExpiresAt) < now) {
                    console.log(`Mute expired for ${userProfile.displayName}. Removing.`);
                    updates.isMuted = false;
                    updates.muteReason = null;
                    updates.muteExpiresAt = null;
                    userProfile.isMuted = false; // Update local state immediately
                }

                // Check if ban is expired
                if (userProfile.isBanned && userProfile.banExpiresAt && new Date(userProfile.banExpiresAt) < now) {
                    console.log(`Ban expired for ${userProfile.displayName}. Removing.`);
                    updates.isBanned = false;
                    updates.banReason = null;
                    updates.banExpiresAt = null;
                    userProfile.isBanned = false; // Update local state immediately
                }

                // If there are any updates, write them back to Firestore
                if (Object.keys(updates).length > 0) {
                    await FirebaseServices.updateDoc(docRef, updates);
                }
                // --- End of new check ---

                console.log("Profile loaded:", userProfile.displayName, "Role:", userProfile.role);
                // Listen for real-time changes to the profile (e.g., role changes by admin)
                FirebaseServices.onSnapshot(docRef, (snapshot) => {
                    if (snapshot.exists()) {
                        userProfile = snapshot.data();
                        console.log("Profile updated in real-time:", userProfile.role);
                        // Re-render nav and current page to reflect new role/status
                        renderNavigation();
                        navigate(currentPage, { force: true });
                    }
                });
            } else {
                userProfile = null;
                console.log("No profile found for UID:", uid);
            }
        }

        // --- CLIENT-SIDE ROUTER AND UI RENDERING ---

        function navigate(page, options = {}) {
            const isAuthPage = ['login', 'signup'].includes(page);
            const requiresAuth = ['chat', 'settings', 'admin'].includes(page);

            if (requiresAuth && !userProfile) {
                if (page !== 'home' && page !== 'login') {
                    showStatus("Access Denied: You must complete your profile and log in to enter the main LuhvVerse.", true);
                    page = 'login';
                }
            }

            // The 'Staff' role check now maps to the lowest staff role (Lunar Guard/Solar Herald)
            if (page === 'admin' && !hasRole('Meteor Knight')) {
                showStatus("Access Denied: High-level staff clearance is required to enter the Admin Console.", true);
                page = 'chat'; // Redirect to the main chat after denial
            }

            // Clean up chat listener if leaving chat page
            if (currentPage === 'chat' && page !== 'chat' && chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }

            currentPage = page;
            window.location.hash = page;
            renderNavigation();
            renderContent(page);
        }

        function renderNavigation() {
            const nav = document.getElementById('nav-links');
            let linksHtml = '';

            const linkClass = 'px-3 py-1 rounded-full text-sm font-semibold transition duration-300';
            const activeClass = 'bg-electric-blue text-soft-black shadow-lg shadow-electric-blue/50';
            const defaultClass = 'text-white/80 hover:text-electric-blue hover:bg-white/10';
            
            const createLink = (page, text, icon) => {
                const isActive = currentPage === page;
                return `
                    <button onclick="navigate('${page}')" class="${linkClass} ${isActive ? activeClass : defaultClass} flex items-center space-x-1">
                        <i class="ph-fill ph-${icon}"></i>
                        <span>${text}</span>
                    </button>
                `;
            };

            if (userProfile) {
                linksHtml += `<span class="text-sm px-2 py-1 rounded-full staff-bg mr-2 text-neon-purple font-display">${userProfile.displayName} (${userProfile.role})</span>`;
                linksHtml += createLink('chat', 'Chat', 'chats-teardrop');
                linksHtml += createLink('settings', 'Settings', 'gear');
                // Check if user has at least Meteor Knight clearance (Rank 3)
                if (hasRole('Meteor Knight')) {
                    linksHtml += createLink('admin', 'Admin', 'shield-star');
                }
                linksHtml += `
                    <button onclick="handleLogout()" class="${linkClass} bg-red-600/30 text-red-400 hover:bg-red-600/50 flex items-center space-x-1">
                        <i class="ph-fill ph-sign-out"></i>
                        <span>Log Out</span>
                    </button>
                `;
            } else {
                linksHtml += createLink('home', 'Home', 'house');
                linksHtml += createLink('login', 'Login', 'sign-in');
                linksHtml += createLink('signup', 'Sign Up', 'user-plus');
            }

            nav.innerHTML = linksHtml;
        }

        function renderContent(page) {
            const content = document.getElementById('content');
            content.innerHTML = ''; // Clear content

            switch (page) {
                case 'home': content.innerHTML = renderHomepage(); break;
                case 'login': content.innerHTML = renderLoginPage(); break;
                case 'signup': content.innerHTML = renderSignupPage(); break;
                case 'chat': renderChatPage(content); break;
                case 'settings': renderSettingsPage(content); break;
                case 'admin': renderAdminPanel(content); break;
                default: navigate('home'); break;
            }
            // Ensure visibility for new content
            content.classList.remove('hidden');
        }

        // --- PAGE RENDERING FUNCTIONS ---

        function renderHomepage() {
            return `
                <div class="max-w-4xl mx-auto p-8 text-center rounded-3xl bg-soft-black/70 border border-neon-purple shadow-xl shadow-neon-purple/20">
                    <h2 class="text-6xl font-display neon-text-purple mb-4 animate-pulse">Welcome to LuhvVerse</h2>
                    <p class="text-xl text-white/80 mb-8">
                        Your personal constellation for friends and fans. Connect in a futuristic, real-time social space designed for play and creativity.
                    </p>
                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6">
                        <button onclick="navigate('login')" class="neon-button text-lg font-display px-8 py-3 rounded-xl">
                            <i class="ph-fill ph-sign-in mr-2"></i> Enter the Constellation
                        </button>
                        <button onclick="navigate('signup')" class="bg-neon-purple/20 text-neon-purple hover:bg-neon-purple/40 neon-button text-lg font-display px-8 py-3 rounded-xl">
                            <i class="ph-fill ph-user-plus mr-2"></i> Create a New Star
                        </button>
                    </div>
                </div>
            `;
        }

        function renderLoginPage() {
            return `
                <div class="max-w-md mx-auto p-8 rounded-2xl bg-soft-black/80 border border-electric-blue shadow-xl shadow-electric-blue/20">
                    <h2 class="text-3xl font-display neon-text-blue mb-6 text-center">Login Protocol</h2>
                    <form onsubmit="handleLogin(event)">
                        <div class="mb-4">
                            <label for="login-email" class="block text-sm font-medium text-white/70">Access Email</label>
                            <input type="email" id="login-email" required class="w-full mt-1 p-3 rounded-lg neon-input">
                        </div>
                        <div class="mb-6">
                            <label for="login-password" class="block text-sm font-medium text-white/70">Security Key</label>
                            <input type="password" id="login-password" required class="w-full mt-1 p-3 rounded-lg neon-input">
                        </div>
                        <button type="submit" class="w-full neon-button font-display px-4 py-3 rounded-lg text-lg">
                            Activate Session
                        </button>
                    </form>
                    <p class="mt-6 text-center text-white/60">
                        New to LuhvVerse? 
                        <button onclick="navigate('signup')" class="text-electric-blue hover:text-neon-purple font-semibold">Create a Star Account</button>
                    </p>
                </div>
            `;
        }

        function renderSignupPage() {
            return `
                <div class="max-w-md mx-auto p-8 rounded-2xl bg-soft-black/80 border border-neon-purple shadow-xl shadow-neon-purple/20">
                    <h2 class="text-3xl font-display neon-text-purple mb-6 text-center">Create Your Star Account</h2>
                    <form onsubmit="handleSignup(event)">
                        <div class="mb-4">
                            <label for="signup-email" class="block text-sm font-medium text-white/70">Quantum Email (Unique)</label>
                            <input type="email" id="signup-email" required class="w-full mt-1 p-3 rounded-lg neon-input">
                        </div>
                        <div class="mb-4">
                            <label for="signup-displayname" class="block text-sm font-medium text-white/70">Display Name (Unique)</label>
                            <input type="text" id="signup-displayname" required class="w-full mt-1 p-3 rounded-lg neon-input">
                        </div>
                        <div class="mb-6">
                            <label for="signup-password" class="block text-sm font-medium text-white/70">Security Key (Password)</label>
                            <input type="password" id="signup-password" required class="w-full mt-1 p-3 rounded-lg neon-input">
                        </div>
                        <button type="submit" class="w-full neon-button font-display px-4 py-3 rounded-lg text-lg bg-neon-purple">
                            Forge Star Identity
                        </button>
                    </form>
                    <p class="mt-6 text-center text-white/60">
                        Already part of the Constellation? 
                        <button onclick="navigate('login')" class="text-neon-purple hover:text-electric-blue font-semibold">Activate Session</button>
                    </p>
                </div>
            `;
        }
        
        // Admin Panel and Settings rendered below for cleaner flow
        // The Chat page is complex and includes the real-time listener logic
        
        // --- AUTH HANDLERS (Signup/Login) ---

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value.trim();
            const displayName = document.getElementById('signup-displayname').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const uid = auth.currentUser.uid;

            if (password.length < 6) {
                showStatus("Security Key must be at least 6 characters long. Protection first!", true);
                return;
            }

            try {
                // 1. Check for uniqueness (Email and Display Name)
                const usersRef = FirebaseServices.collection(db, PATHS.USERS);
                const qEmail = FirebaseServices.query(usersRef, FirebaseServices.where('email', '==', email));
                const qDisplay = FirebaseServices.query(usersRef, FirebaseServices.where('displayName', '==', displayName));

                const [emailSnap, displaySnap] = await Promise.all([
                    FirebaseServices.getDocs(qEmail),
                    FirebaseServices.getDocs(qDisplay)
                ]);

                if (!emailSnap.empty || !displaySnap.empty) {
                    // UPDATED ERROR MESSAGE as requested by user
                    showStatus("Error: A Star Identity already exists with this Quantum Email or Display Name. Please change your details to 'Forge Star Identity'.", true);
                    return;
                }

                // 2. Determine Role (First user is LuhvReuben, subsequent is Galactic Explorer)
                const allUsersSnap = await FirebaseServices.getDocs(usersRef);
                const role = allUsersSnap.empty ? 'LuhvReuben' : 'Galactic Explorer';

                // 3. Create User Profile
                const userData = {
                    email: email,
                    displayName: displayName,
                    passwordHash: simpleHash(password), // Store simple hash for login verification
                    role: role,
                    isMuted: false,
                    isBanned: false,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                };

                await FirebaseServices.setDoc(FirebaseServices.doc(db, PATHS.USERS, uid), userData);
                
                // 4. Create default settings
                const defaultSettings = {
                    avatar: 'ph-user',
                    themeMode: 'default',
                    notificationToggle: true,
                    statusMessage: 'Just orbiting...',
                    chatBubbleColor: '#9B59B6',
                    fontStyle: 'Inter',
                    chatSoundEffects: true,
                    messagePreview: true,
                    autoScroll: true
                };
                await FirebaseServices.setDoc(FirebaseServices.doc(db, PATHS.SETTINGS(uid)), defaultSettings);


                await loadUserProfile(uid); // Load the newly created profile
                
                // Show 3-second loading (FIXED: Calling the correctly named function)
                await showUniverseLoading("Star Identity Forged! Entering LuhvVerse...");
                
                showStatus(`Welcome, ${displayName}! Your role is: ${role}.`, false);
                navigate('chat');

            } catch (e) {
                console.error("Signup failed:", e);
                showStatus(`Identity Forge Failure: ${e.message}`, true);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();
            const passwordHash = simpleHash(password);

            try {
                // 1. Find user profile by email and password hash
                const usersRef = FirebaseServices.collection(db, PATHS.USERS);
                const q = FirebaseServices.query(
                    usersRef, 
                    FirebaseServices.where('email', '==', email),
                    FirebaseServices.where('passwordHash', '==', passwordHash)
                );

                const snap = await FirebaseServices.getDocs(q);

                if (snap.empty) {
                    showStatus("Security Error: Unknown Quantum Email or Security Key mismatch. Access denied.", true);
                    return;
                }

                const userDoc = snap.docs[0];
                const profile = userDoc.data();
                const targetUid = userDoc.id;
                
                // 2. Update the currently signed-in anonymous user's UID data
                
                // Update last login timestamp
                await FirebaseServices.updateDoc(userDoc.ref, { lastLogin: new Date().toISOString() });

                // We rely on the existing UID and ensure it has the correct profile data loaded.
                
                if (targetUid !== auth.currentUser.uid) {
                    // This is a necessary hack/workaround to ensure the current session loads the correct profile
                    await loadUserProfile(targetUid);
                } else {
                    await loadUserProfile(targetUid);
                }
                
                if (userProfile.isBanned) {
                    showStatus("ACCESS BLOCKED. Your connection to the LuhvVerse is permanently restricted.", true);
                    await handleLogout(); // Ensure session is cleared
                    return;
                }

                // Show 3-second loading (FIXED: Calling the correctly named function)
                await showUniverseLoading("Session activated. Entering main hub...");
                
                showStatus(`Welcome back, ${profile.displayName}! Role: ${profile.role}.`, false);
                navigate('chat');

            } catch (e) {
                console.error("Login failed:", e);
                showStatus(`Session Activation Failed: ${e.message}`, true);
            }
        }
        
        async function handleLogout() {
            try {
                // Sign out the current Firebase user (removes token in real environment)
                await FirebaseServices.signOut(auth);
                // Since we rely on the custom token, the app will likely sign back in anonymously, 
                // but the userProfile will be cleared, forcing a login/signup.
                userProfile = null;
                userId = null;
                showStatus("Session terminated. See you in the next orbit!", false);
                navigate('home');
            } catch(e) {
                console.error("Logout failed:", e);
                showStatus("Error terminating session.", true);
            }
        }

        // --- CHAT PAGE (Real-Time) ---
        
        async function renderChatPage(content) {
            if (!userProfile) {
                content.innerHTML = `<p class="text-center text-red-400">Error: Profile not loaded. Please log in.</p>`;
                navigate('login');
                return;
            }
            
            if (userProfile.isBanned) {
                content.innerHTML = `<div class="p-8 text-center"><h2 class="text-4xl neon-text-purple">BANNED FROM LUHVVERSE</h2><p class="text-xl mt-4">Your access is restricted. Contact staff for details.</p></div>`;
                return;
            }

            // Fetch user's settings to apply styles
            let settings = await fetchUserSettings();
            const bubbleColor = settings.chatBubbleColor || 'rgba(155, 89, 182, 0.4)';
            const fontStyle = settings.fontStyle === 'Orbitron' ? 'var(--font-display)' : 'var(--font-body)';
            
            content.innerHTML = `
                <div class="max-w-4xl mx-auto h-[70vh] flex flex-col rounded-2xl bg-soft-black/80 border border-neon-purple shadow-xl shadow-neon-purple/20">
                    <h2 class="text-2xl font-display neon-text-purple p-4 border-b border-neon-purple/50">
                        <i class="ph-fill ph-chats-teardrop mr-2"></i> Global Constellation Chat
                    </h2>
                    
                    <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4">
                        <!-- Messages will be injected here -->
                    </div>

                    ${userProfile.isMuted ? 
                        `<div class="p-3 text-center text-red-400 border-t border-red-400/50 text-sm">
                            <strong class="flex items-center justify-center text-base mb-1"><i class="ph-fill ph-speaker-slash mr-2"></i> MUTED</strong>
                            <p>You can read but not send messages.</p>
                            <p class="mt-1"><span class="font-semibold text-white/70">Reason:</span> ${userProfile.muteReason || 'No reason specified.'}</p>
                            <p><span class="font-semibold text-white/70">Expires:</span> ${userProfile.muteExpiresAt ? new Date(userProfile.muteExpiresAt).toLocaleString() : 'Permanent'}</p>
                        </div>` : 
                        `<form onsubmit="handleSendMessage(event)" class="p-4 border-t border-electric-blue/50 flex space-x-2">
                            <input type="text" id="chat-input" placeholder="Transmit a message..." required class="flex-grow p-3 rounded-lg neon-input" style="font-family: ${fontStyle};">
                            <button type="submit" class="neon-button px-6 py-3 rounded-lg font-display">
                                <i class="ph-fill ph-paper-plane-right"></i> Send
                            </button>
                        </form>`
                    }
                </div>
            `;
            
            // Start real-time listener
            setupChatListener(settings.autoScroll);
        }

        async function setupChatListener(autoScroll) {
            if (!db || !userId) return;

            const chatRef = FirebaseServices.collection(db, PATHS.CHAT);
            const q = FirebaseServices.query(chatRef); // No orderBy to avoid needing indexes

            // Unsubscribe from previous listener if it exists
            if (chatUnsubscribe) { chatUnsubscribe(); }

            chatUnsubscribe = FirebaseServices.onSnapshot(q, (snapshot) => {
                const messages = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Manually sort by timestamp in memory (no orderBy in query)
                    messages.push({ id: doc.id, ...data });
                });
                
                // Sort by timestamp (descending or ascending for display)
                messages.sort((a, b) => (new Date(a.timestamp || 0)).getTime() - (new Date(b.timestamp || 0)).getTime());

                renderChatMessages(messages, autoScroll);
            }, (error) => {
                console.error("Chat Listener Error:", error);
                showStatus("Chat connection lost. Please refresh.", true);
            });
        }

        function renderChatMessages(messages, autoScroll) {
            const container = document.getElementById('chat-messages');
            if (!container) return; // Chat page not active

            // Keep track of scroll position before rendering
            const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 1;
            
            let html = '';
            messages.forEach(msg => {
                const isSelf = msg.userId === userId;
                const bubbleClass = isSelf ? 'chat-bubble-self ml-auto' : 'mr-auto';
                const textColor = isSelf ? 'text-soft-black' : 'text-white';
                const bubbleStyle = isSelf 
                    ? `background-color: ${msg.bubbleColor || userProfile.chatBubbleColor || '#9B59B6'}; color: #1E1E1E;`
                    : `border-left: 3px solid ${msg.bubbleColor || '#3498DB'};`; // Others' bubbles have a blue accent

                // Use Meteor Knight as the check for staff visibility on chat badges
                const roleBadge = hasRole('Meteor Knight') && staffRoles.includes(msg.role) 
                    ? `<span class="text-xs bg-neon-purple/50 px-1 rounded-full ml-2">${msg.role}</span>`
                    : '';
                
                // Moderator check is Meteor Knight or higher
                const deleteButton = hasRole('Meteor Knight') 
                    ? `<button onclick="deleteChatMessage('${msg.id}')" class="text-red-400 hover:text-red-600 ml-2 text-xs"><i class="ph-fill ph-trash"></i></button>`
                    : '';

                const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                html += `
                    <div class="flex ${isSelf ? 'justify-end' : 'justify-start'}">
                        <div id="msg-${msg.id}" class="chat-bubble p-3 max-w-xs md:max-w-md ${bubbleClass}" style="${bubbleStyle}">
                            <div class="font-bold text-sm mb-1 ${isSelf ? 'text-soft-black/80' : 'text-electric-blue'}">
                                ${msg.displayName} ${roleBadge}
                            </div>
                            <p class="${textColor}">${msg.message}</p>
                            <div class="flex justify-end items-center text-xs mt-1 ${isSelf ? 'text-soft-black/60' : 'text-white/60'}">
                                <span>${time}</span>
                                ${deleteButton}
                            </div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;

            // Auto-scroll logic
            if (autoScroll || isScrolledToBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }

        async function handleSendMessage(event) {
            event.preventDefault();
            if (userProfile.isMuted) return; // Client-side mute block

            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            try {
                // Fetch user's settings to get the latest bubble color
                const settings = await fetchUserSettings();
                const bubbleColor = settings.chatBubbleColor || '#9B59B6';

                const chatRef = FirebaseServices.collection(db, PATHS.CHAT);
                await FirebaseServices.setDoc(FirebaseServices.doc(chatRef), {
                    userId: userId,
                    displayName: userProfile.displayName,
                    role: userProfile.role,
                    message: message,
                    timestamp: new Date().toISOString(),
                    bubbleColor: bubbleColor
                });
                
                input.value = '';
                if (settings.chatSoundEffects) {
                    playChatSound();
                }
            } catch (e) {
                console.error("Message send failed:", e);
                showStatus(`Transmission Failure: ${e.message}`, true);
            }
        }
        
        async function deleteChatMessage(messageId) {
            // Check for Meteor Knight clearance or higher
            if (!hasRole('Meteor Knight')) {
                showStatus("Unauthorized action: Cannot delete messages.", true);
                return;
            }
            try {
                const messageRef = FirebaseServices.doc(db, PATHS.CHAT, messageId);
                await FirebaseServices.deleteDoc(messageRef);
                showStatus("Message successfully vaporized.", false);
                await logStaffAction('Delete Message', `Message ID: ${messageId}`);
            } catch (e) {
                console.error("Delete message failed:", e);
                showStatus(`Vaporization Failed: ${e.message}`, true);
            }
        }
        
        function playChatSound() {
            // Use Tone.js or a simple HTML Audio element for sound effects
            // Due to constraints, using a simple tone.js placeholder (not available here) or silent.
            // Placeholder: console.log("Chat sound played.");
        }


        // --- USER SETTINGS PAGE ---

        const SETTINGS_DEFAULTS = {
            avatar: 'ph-user', themeMode: 'default', notificationToggle: true, statusMessage: 'Just orbiting...',
            chatBubbleColor: '#9B59B6', fontStyle: 'Inter', chatSoundEffects: true, messagePreview: true, autoScroll: true
        };

        async function fetchUserSettings() {
            if (!userId) return SETTINGS_DEFAULTS;
            try {
                const docRef = FirebaseServices.doc(db, PATHS.SETTINGS(userId));
                const docSnap = await FirebaseServices.getDoc(docRef);
                return docSnap.exists() ? { ...SETTINGS_DEFAULTS, ...docSnap.data() } : SETTINGS_DEFAULTS;
            } catch (e) {
                console.error("Error fetching settings:", e);
                return SETTINGS_DEFAULTS;
            }
        }

        async function renderSettingsPage(content) {
            if (!userProfile) return;
            const settings = await fetchUserSettings();
            const currentProfile = userProfile;
            
            const themeOptions = { 'default': 'Default (Soft Black)', 'neon-dark': 'Neon Dark', 'electric-glow': 'Electric Glow' };
            const fontOptions = { 'Inter': 'Inter (Body)', 'Orbitron': 'Orbitron (Display)' };
            
            content.innerHTML = `
                <div class="max-w-4xl mx-auto p-8 rounded-2xl bg-soft-black/80 border border-electric-blue shadow-xl shadow-electric-blue/20">
                    <h2 class="text-3xl font-display neon-text-blue mb-8 text-center">
                        <i class="ph-fill ph-gear mr-2"></i> User Configuration
                    </h2>
                    
                    <form onsubmit="handleSettingsUpdate(event)">
                        
                        <!-- Profile Block -->
                        <div class="mb-8 p-6 rounded-xl border border-neon-purple/50 bg-soft-black/50">
                            <h3 class="text-xl font-display neon-text-purple mb-4">Identity Matrix</h3>
                            <div class="mb-4">
                                <label for="setting-displayname" class="block text-sm font-medium text-white/70">Display Name</label>
                                <input type="text" id="setting-displayname" value="${currentProfile.displayName}" required class="w-full mt-1 p-3 rounded-lg neon-input">
                            </div>
                            <div class="mb-4">
                                <label for="setting-statusmessage" class="block text-sm font-medium text-white/70">Status Message</label>
                                <input type="text" id="setting-statusmessage" value="${settings.statusMessage}" maxlength="50" class="w-full mt-1 p-3 rounded-lg neon-input">
                            </div>
                            <div class="mb-4">
                                <label for="setting-avatar" class="block text-sm font-medium text-white/70">Avatar (Phosphor Icon Name, e.g., 'rocket')</label>
                                <input type="text" id="setting-avatar" value="${settings.avatar}" class="w-full mt-1 p-3 rounded-lg neon-input">
                            </div>
                        </div>

                        <!-- Chat & UI Block -->
                        <div class="mb-8 p-6 rounded-xl border border-electric-blue/50 bg-soft-black/50">
                            <h3 class="text-xl font-display neon-text-blue mb-4">Chat Interface</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="setting-bubblecolor" class="block text-sm font-medium text-white/70">Chat Bubble Color</label>
                                    <input type="color" id="setting-bubblecolor" value="${settings.chatBubbleColor}" class="w-full mt-1 h-10 rounded-lg neon-input p-1">
                                </div>
                                <div>
                                    <label for="setting-fontstyle" class="block text-sm font-medium text-white/70">Font Style</label>
                                    <select id="setting-fontstyle" class="w-full mt-1 p-3 rounded-lg neon-input">
                                        ${Object.entries(fontOptions).map(([val, text]) => 
                                            `<option value="${val}" ${settings.fontStyle === val ? 'selected' : ''}>${text}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="setting-autoscroll" ${settings.autoScroll ? 'checked' : ''} class="h-5 w-5 rounded neon-purple-accent">
                                    <label for="setting-autoscroll" class="text-sm font-medium text-white/70">Auto-scroll Chat</label>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="setting-sounds" ${settings.chatSoundEffects ? 'checked' : ''} class="h-5 w-5 rounded neon-purple-accent">
                                    <label for="setting-sounds" class="text-sm font-medium text-white/70">Chat Sound Effects</label>
                                </div>
                            </div>
                        </div>

                        <!-- System Block -->
                        <div class="p-6 rounded-xl border border-neon-purple/50 bg-soft-black/50">
                            <h3 class="text-xl font-display neon-text-purple mb-4">System and Notifications</h3>
                             <div class="mb-4">
                                <label for="setting-theme" class="block text-sm font-medium text-white/70">Theme Mode</label>
                                <select id="setting-theme" class="w-full mt-1 p-3 rounded-lg neon-input">
                                    ${Object.entries(themeOptions).map(([val, text]) => 
                                        `<option value="${val}" ${settings.themeMode === val ? 'selected' : ''}>${text}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" id="setting-notifications" ${settings.notificationToggle ? 'checked' : ''} class="h-5 w-5 rounded neon-purple-accent">
                                <label for="setting-notifications" class="text-sm font-medium text-white/70">Enable Notifications</label>
                            </div>
                        </div>

                        <button type="submit" class="w-full neon-button font-display px-4 py-3 rounded-lg text-lg mt-8">
                            <i class="ph-fill ph-floppy-disk mr-2"></i> Save Configuration
                        </button>
                    </form>
                </div>
            `;
        }

        async function handleSettingsUpdate(event) {
            event.preventDefault();

            const newDisplayName = document.getElementById('setting-displayname').value.trim();
            const newStatus = document.getElementById('setting-statusmessage').value.trim();
            
            if (newDisplayName !== userProfile.displayName) {
                // Check uniqueness of new display name
                const usersRef = FirebaseServices.collection(db, PATHS.USERS);
                const qDisplay = FirebaseServices.query(usersRef, FirebaseServices.where('displayName', '==', newDisplayName));
                const displaySnap = await FirebaseServices.getDocs(qDisplay);
                
                if (!displaySnap.empty && displaySnap.docs[0].id !== userId) {
                    showStatus("Error: This new Display Name is already in use by another star.", true);
                    return;
                }
            }

            const newSettings = {
                avatar: document.getElementById('setting-avatar').value,
                statusMessage: newStatus,
                themeMode: document.getElementById('setting-theme').value,
                chatBubbleColor: document.getElementById('setting-bubblecolor').value,
                fontStyle: document.getElementById('setting-fontstyle').value,
                notificationToggle: document.getElementById('setting-notifications').checked,
                chatSoundEffects: document.getElementById('setting-sounds').checked,
                autoScroll: document.getElementById('setting-autoscroll').checked,
            };

            try {
                // 1. Update Profile (Display Name)
                const profileRef = FirebaseServices.doc(db, PATHS.USERS, userId);
                await FirebaseServices.updateDoc(profileRef, { displayName: newDisplayName });

                // 2. Update Private Settings
                const settingsRef = FirebaseServices.doc(db, PATHS.SETTINGS(userId));
                await FirebaseServices.setDoc(settingsRef, newSettings);

                // Re-load profile to update global state
                await loadUserProfile(userId);
                
                showStatus("Configuration saved successfully. Changes deployed.", false);
                navigate('settings', { force: true }); // Re-render settings page
            } catch (e) {
                console.error("Settings update failed:", e);
                showStatus(`Configuration Save Error: ${e.message}`, true);
            }
        }

        // --- ADMIN PANEL ---

        async function renderAdminPanel(content) {
            // Check for Meteor Knight clearance or higher
            if (!hasRole('Meteor Knight')) {
                content.innerHTML = `<div class="p-8 text-center text-red-400">Unauthorized: High-Level Staff Clearance Required.</div>`;
                return;
            }

            content.innerHTML = `
                <div class="max-w-6xl mx-auto p-8 rounded-2xl bg-soft-black/80 border border-neon-purple shadow-xl shadow-neon-purple/20 staff-bg">
                    <h2 class="text-3xl font-display neon-text-purple mb-8 text-center">
                        <i class="ph-fill ph-shield-star mr-2"></i> Admin Console (${userProfile.role})
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <!-- User Management Panel -->
                        <div class="lg:col-span-2 p-6 rounded-xl border border-electric-blue/50 bg-soft-black/50">
                            <h3 class="text-xl font-display neon-text-blue mb-4 flex items-center"><i class="ph-fill ph-users mr-2"></i> User Matrix</h3>
                            <div class="mb-4">
                                <label for="admin-target-user" class="block text-sm font-medium text-white/70">Target User (Display Name or UID)</label>
                                <input type="text" id="admin-target-user" placeholder="Enter Display Name or full UID" class="w-full mt-1 p-3 rounded-lg neon-input">
                            </div>

                            <!-- NEW: Reason and Duration Inputs -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                                <div>
                                    <label for="admin-action-reason" class="block text-sm font-medium text-white/70">Reason</label>
                                    <input type="text" id="admin-action-reason" placeholder="Reason for action (logs)" class="w-full mt-1 p-3 rounded-lg neon-input">
                                </div>
                                <div>
                                    <label for="admin-action-duration" class="block text-sm font-medium text-white/70">Duration (in hours)</label>
                                    <input type="number" id="admin-action-duration" placeholder="0 for permanent" class="w-full mt-1 p-3 rounded-lg neon-input" min="0">
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                <button onclick="adminMuteUser(true)" class="neon-button px-3 py-2 text-sm bg-yellow-600/30">Mute</button>
                                <button onclick="adminMuteUser(false)" class="neon-button px-3 py-2 text-sm bg-green-600/30">Unmute</button>
                                <button onclick="adminBanUser(true)" class="neon-button px-3 py-2 text-sm bg-red-600/30">Ban</button>
                                <button onclick="adminBanUser(false)" class="neon-button px-3 py-2 text-sm bg-green-600/30">Unban</button>
                            </div>

                            <div class="mt-6">
                                <label for="admin-role-select" class="block text-sm font-medium text-white/70">Assign New Role</label>
                                <div class="flex space-x-2 mt-1">
                                    <select id="admin-role-select" class="flex-grow p-3 rounded-lg neon-input">
                                        ${Object.keys(ROLES).filter(role => ROLES[role] < ROLES[userProfile.role]).map(role => 
                                            `<option value="${role}">${role}</option>`
                                        ).join('')}
                                    </select>
                                    <button onclick="adminAssignRole()" class="neon-button px-4 py-3 text-sm">Assign</button>
                                </div>
                            </div>
                        </div>

                        <!-- Chat Control Panel -->
                        <div class="p-6 rounded-xl border border-neon-purple/50 bg-soft-black/50">
                            <h3 class="text-xl font-display neon-text-purple mb-4 flex items-center"><i class="ph-fill ph-broadcast mr-2"></i> Chat Control</h3>
                            <button onclick="adminClearChat()" class="w-full neon-button px-3 py-2 text-sm bg-red-800/50 hover:bg-red-800/80 mb-4">
                                <i class="ph-fill ph-eraser"></i> Clear All Chat History
                            </button>
                            <label for="admin-announcement" class="block text-sm font-medium text-white/70">Global Announcement</label>
                            <textarea id="admin-announcement" rows="3" class="w-full mt-1 p-3 rounded-lg neon-input" placeholder="Type global system message here..."></textarea>
                            <button onclick="adminSendAnnouncement()" class="w-full neon-button px-3 py-2 text-sm mt-2">
                                <i class="ph-fill ph-speaker-high"></i> Send Announcement
                            </button>
                        </div>
                    </div>

                    <!-- Staff Logs (Minimalistic Display) -->
                    <div class="mt-8 p-6 rounded-xl border border-neon-purple shadow-xl shadow-neon-purple/20">
                        <h3 class="text-xl font-display neon-text-purple mb-4 flex items-center"><i class="ph-fill ph-clipboard-text mr-2"></i> Staff Logs</h3>
                        <div id="staff-logs" class="max-h-64 overflow-y-auto text-sm space-y-2">
                            <p class="text-center text-white/60">Loading logs...</p>
                        </div>
                    </div>
                </div>
            `;
            loadStaffLogs();
        }

        async function findUserByInput(input) {
            const cleanInput = input.trim();
            if (!cleanInput) return null;

            // 1. Check if input is a UID (simple length heuristic)
            if (cleanInput.length > 20) {
                const docRef = FirebaseServices.doc(db, PATHS.USERS, cleanInput);
                const docSnap = await FirebaseServices.getDoc(docRef);
                return docSnap.exists() ? { docId: docSnap.id, data: docSnap.data(), ref: docRef } : null;
            }

            // 2. Check if input is a Display Name
            const usersRef = FirebaseServices.collection(db, PATHS.USERS);
            const q = FirebaseServices.query(usersRef, FirebaseServices.where('displayName', '==', cleanInput));
            const snap = await FirebaseServices.getDocs(q);

            if (!snap.empty) {
                const doc = snap.docs[0];
                return { docId: doc.id, data: doc.data(), ref: doc.ref };
            }

            return null; // User not found
        }
        
        // Admin Utility: Log Action
        async function logStaffAction(action, details) {
            if (!userId) return; // Must be logged in
            try {
                const logsRef = FirebaseServices.collection(db, PATHS.LOGS);
                await FirebaseServices.setDoc(FirebaseServices.doc(logsRef), {
                    staffId: userId,
                    staffName: userProfile.displayName,
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                });
            } catch(e) {
                console.error("Failed to log action:", e);
            }
        }

        async function loadStaffLogs() {
            const logsContainer = document.getElementById('staff-logs');
            if (!logsContainer) return;
            
            const logsRef = FirebaseServices.collection(db, PATHS.LOGS);
            // Limit to last 10, no orderBy constraint
            const q = FirebaseServices.query(logsRef); 

            FirebaseServices.onSnapshot(q, (snapshot) => {
                const logs = [];
                snapshot.forEach(doc => logs.push({ id: doc.id, ...doc.data() }));

                // Manually sort by timestamp DESC in memory
                logs.sort((a, b) => (new Date(b.timestamp)).getTime() - (new Date(a.timestamp)).getTime());
                logs.splice(10); // Keep only the last 10

                logsContainer.innerHTML = logs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    return `<p class="border-b border-white/10 pb-1"><span class="text-white/50">(${time})</span> <span class="text-electric-blue">${log.staffName}:</span> ${log.action} - <span class="text-white/80">${log.details}</span></p>`;
                }).join('');

                if (logs.length === 0) {
                     logsContainer.innerHTML = '<p class="text-center text-white/60">No staff actions recorded.</p>';
                }
            }, (error) => {
                 logsContainer.innerHTML = `<p class="text-center text-red-400">Error loading logs: ${error.message}</p>`;
            });
        }

        // Admin Action: Mute/Unmute
        async function adminMuteUser(isMute) {
            // Check for Meteor Knight clearance or higher
            if (!hasRole('Meteor Knight')) return showStatus("Insufficient clearance.", true);

            const input = document.getElementById('admin-target-user').value;
            const target = await findUserByInput(input);
            if (!target) return showStatus("Target user not found.", true);
            
            // Cannot modify user with equal or higher rank
            if (ROLES[target.data.role] >= ROLES[userProfile.role]) {
                return showStatus("Cannot modify users with equal or higher rank.", true);
            }

            try {
                let updates = { isMuted: isMute };
                let logDetails = `User: ${target.data.displayName} (${target.docId})`;
                const action = isMute ? 'Muted' : 'Unmuted';

                if (isMute) {
                    const reason = document.getElementById('admin-action-reason').value.trim() || 'No reason specified.';
                    const durationHours = parseInt(document.getElementById('admin-action-duration').value) || 0;
                    
                    updates.muteReason = reason;
                    if (durationHours > 0) {
                        const expiryDate = new Date(Date.now() + durationHours * 60 * 60 * 1000).toISOString();
                        updates.muteExpiresAt = expiryDate;
                        logDetails += ` for ${durationHours} hours. Reason: ${reason}`;
                    } else {
                        updates.muteExpiresAt = null; // Permanent
                        logDetails += ` permanently. Reason: ${reason}`;
                    }
                } else {
                    // Clear reason and expiry on unmute
                    updates.muteReason = null;
                    updates.muteExpiresAt = null;
                }

                await FirebaseServices.updateDoc(target.ref, updates);
                showStatus(`${action} user ${target.data.displayName}.`, false);
                await logStaffAction(action, logDetails);
            } catch (e) {
                showStatus(`Mute/Unmute failed: ${e.message}`, true);
            }
        }

        // Admin Action: Ban/Unban
        async function adminBanUser(isBan) {
            // Check for Meteor Knight clearance or higher
            if (!hasRole('Meteor Knight')) return showStatus("Insufficient clearance.", true);

            const input = document.getElementById('admin-target-user').value;
            const target = await findUserByInput(input);
            if (!target) return showStatus("Target user not found.", true);

            // Cannot modify user with equal or higher rank
            if (ROLES[target.data.role] >= ROLES[userProfile.role]) {
                return showStatus("Cannot modify users with equal or higher rank.", true);
            }

            try {
                let updates = { isBanned: isBan };
                let logDetails = `User: ${target.data.displayName} (${target.docId})`;
                const action = isBan ? 'Banned' : 'Unbanned';

                if (isBan) {
                    const reason = document.getElementById('admin-action-reason').value.trim() || 'No reason specified.';
                    const durationHours = parseInt(document.getElementById('admin-action-duration').value) || 0;
                    
                    updates.isMuted = true; // Banning also mutes
                    updates.banReason = reason;
                    
                    if (durationHours > 0) {
                        const expiryDate = new Date(Date.now() + durationHours * 60 * 60 * 1000).toISOString();
                        updates.banExpiresAt = expiryDate;
                        logDetails += ` for ${durationHours} hours. Reason: ${reason}`;
                    } else {
                        updates.banExpiresAt = null; // Permanent
                        logDetails += ` permanently. Reason: ${reason}`;
                    }
                } else {
                    // Clear reason and expiry on unban
                    // Note: This does NOT automatically unmute them.
                    updates.banReason = null;
                    updates.banExpiresAt = null;
                }

                await FirebaseServices.updateDoc(target.ref, updates);
                showStatus(`${action} user ${target.data.displayName}.`, false);
                await logStaffAction(action, logDetails);
            } catch (e) {
                showStatus(`Ban/Unban failed: ${e.message}`, true);
            }
        }

        // Admin Action: Assign Role
        async function adminAssignRole() {
            const newRole = document.getElementById('admin-role-select').value;
            // Check for Nebula Officer clearance or higher for role assignment
            if (!hasRole('Nebula Officer')) return showStatus("Role assignment requires Nebula Officer clearance or higher.", true);
            
            const input = document.getElementById('admin-target-user').value;
            const target = await findUserByInput(input);
            if (!target) return showStatus("Target user not found.", true);

            // Cannot assign a role higher than or equal to current staff's role
            if (ROLES[newRole] >= ROLES[userProfile.role]) {
                return showStatus("Cannot assign a role equal to or higher than your own.", true);
            }
            // Cannot change the role of a user with a rank equal to or higher than current staff's role
            if (ROLES[target.data.role] >= ROLES[userProfile.role]) {
                return showStatus("Cannot change the role of a user with equal or higher rank.", true);
            }
            
            try {
                await FirebaseServices.updateDoc(target.ref, { role: newRole });
                showStatus(`Role of ${target.data.displayName} changed to ${newRole}.`, false);
                await logStaffAction('Role Change', `User: ${target.data.displayName}, New Role: ${newRole}`);
            } catch (e) {
                showStatus(`Role assignment failed: ${e.message}`, true);
            }
        }

        // Admin Action: Clear Chat
        async function adminClearChat() {
            // Check for Cosmic Captain clearance or higher
            if (!hasRole('Cosmic Captain')) return showStatus("Chat Clear requires Cosmic Captain clearance or higher.", true);

            // Use a custom modal for confirmation instead of window.confirm
            // For this fix, we'll assume the user confirms, but ideally, a modal would be built.
            // Since we can't use confirm(), we'll just proceed, but add a console log.
            console.warn("Skipping confirm() for chat clear due to environment constraints.");
            // if (!confirm("Are you sure you want to clear ALL chat history? This is irreversible.")) return;

            try {
                const chatRef = FirebaseServices.collection(db, PATHS.CHAT);
                const snapshot = await FirebaseServices.getDocs(chatRef);
                
                const batch = FirebaseServices.writeBatch(db);
                snapshot.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                showStatus("Chat history successfully purged from the Constellation.", false);
                await logStaffAction('Clear Chat', 'All messages deleted.');
            } catch (e) {
                showStatus(`Chat clear failed: ${e.message}`, true);
            }
        }

        // Admin Action: Send Global Announcement
        async function adminSendAnnouncement() {
            // Check for Solar Herald clearance or higher
            if (!hasRole('Solar Herald')) return showStatus("Announcement requires Solar Herald clearance or higher.", true);

            const message = document.getElementById('admin-announcement').value.trim();
            if (!message) return;
            
            try {
                const chatRef = FirebaseServices.collection(db, PATHS.CHAT);
                await FirebaseServices.setDoc(FirebaseServices.doc(chatRef), {
                    userId: 'SYSTEM',
                    displayName: 'SYSTEM ANNOUNCEMENT',
                    role: userProfile.role,
                    message: `<span class="neon-text-purple font-bold">${message}</span>`,
                    timestamp: new Date().toISOString(),
                    bubbleColor: '#9B59B6', // Special color for system
                });
                
                document.getElementById('admin-announcement').value = '';
                showStatus("Global Announcement successfully broadcast.", false);
                await logStaffAction('Announcement', message);
            } catch (e) {
                showStatus(`Announcement broadcast failed: ${e.message}`, true);
            }
        }

        // --- INITIAL STARTUP ---
        window.onload = initFirebase;
    </script>
</body>
</html>
